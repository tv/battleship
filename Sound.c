#include "Sound.h"

static volatile HANDLE		recordBufferReadyRead = 0;
static volatile HANDLE		recordBufferReadyWrite = 0;

static const short dcttable[20][64] =
	{{1021, 1013, 999, 980, 955, 926, 891, 851, 807, 759, 706, 650, 590, 526, 460, 392, 321, 249, 175, 100, 25, -50, -125, -200, -273, -345, -415, -483, -548, -610, -669, -724, -775, -822, -865, -903, -936, -964, -987, -1004, -1016, -1023, -1024, -1019, -1009, -993, -972, -946, -915, -878, -837, -792, -742, -688, -630, -569, -505, -438, -369, -297, -224, -150, -75, 0},
	{1016, 993, 955, 903, 837, 759, 669, 569, 460, 345, 224, 100, -25, -150, -273, -392, -505, -610, -706, -792, -865, -926, -972, -1004, -1021, -1023, -1009, -980, -936, -878, -807, -724, -630, -526, -415, -297, -175, -50, 75, 200, 321, 438, 548, 650, 742, 822, 891, 946, 987, 1013, 1024, 1019, 999, 964, 915, 851, 775, 688, 590, 483, 369, 249, 125, 0},
	{1009, 964, 891, 792, 669, 526, 369, 200, 25, -150, -321, -483, -630, -759, -865, -946, -999, -1023, -1016, -980, -915, -822, -706, -569, -415, -249, -75, 100, 273, 438, 590, 724, 837, 926, 987, 1019, 1021, 993, 936, 851, 742, 610, 460, 297, 125, -50, -224, -392, -548, -688, -807, -903, -972, -1013, -1024, -1004, -955, -878, -775, -650, -505, -345, -175, 0},
	{999, 926, 807, 650, 460, 249, 25, -200, -415, -610, -775, -903, -987, -1023, -1009, -946, -837, -688, -505, -297, -75, 150, 369, 569, 742, 878, 972, 1019, 1016, 964, 865, 724, 548, 345, 125, -100, -321, -526, -706, -851, -955, -1013, -1021, -980, -891, -759, -590, -392, -175, 50, 273, 483, 669, 822, 936, 1004, 1024, 993, 915, 792, 630, 438, 224, 0},
	{987, 878, 706, 483, 224, -50, -321, -569, -775, -926, -1009, -1019, -955, -822, -630, -392, -125, 150, 415, 650, 837, 964, 1021, 1004, 915, 759, 548, 297, 25, -249, -505, -724, -891, -993, -1024, -980, -865, -688, -460, -200, 75, 345, 590, 792, 936, 1013, 1016, 946, 807, 610, 369, 100, -175, -438, -669, -851, -972, -1023, -999, -903, -742, -526, -273, 0},
	{972, 822, 590, 297, -25, -345, -630, -851, -987, -1023, -955, -792, -548, -249, 75, 392, 669, 878, 999, 1019, 936, 759, 505, 200, -125, -438, -706, -903, -1009, -1013, -915, -724, -460, -150, 175, 483, 742, 926, 1016, 1004, 891, 688, 415, 100, -224, -526, -775, -946, -1021, -993, -865, -650, -369, -50, 273, 569, 807, 964, 1024, 980, 837, 610, 321, 0},
	{955, 759, 460, 100, -273, -610, -865, -1004, -1009, -878, -630, -297, 75, 438, 742, 946, 1024, 964, 775, 483, 125, -249, -590, -851, -999, -1013, -891, -650, -321, 50, 415, 724, 936, 1023, 972, 792, 505, 150, -224, -569, -837, -993, -1016, -903, -669, -345, 25, 392, 706, 926, 1021, 980, 807, 526, 175, -200, -548, -822, -987, -1019, -915, -688, -369, 0},
	{936, 688, 321, -100, -505, -822, -999, -1004, -837, -526, -125, 297, 669, 926, 1024, 946, 706, 345, -75, -483, -807, -993, -1009, -851, -548, -150, 273, 650, 915, 1023, 955, 724, 369, -50, -460, -792, -987, -1013, -865, -569, -175, 249, 630, 903, 1021, 964, 742, 392, -25, -438, -775, -980, -1016, -878, -590, -200, 224, 610, 891, 1019, 972, 759, 415, 0},
	{915, 610, 175, -297, -706, -964, -1016, -851, -505, -50, 415, 792, 999, 993, 775, 392, -75, -526, -865, -1019, -955, -688, -273, 200, 630, 926, 1024, 903, 590, 150, -321, -724, -972, -1013, -837, -483, -25, 438, 807, 1004, 987, 759, 369, -100, -548, -878, -1021, -946, -669, -249, 224, 650, 936, 1023, 891, 569, 125, -345, -742, -980, -1009, -822, -460, 0},
	{891, 526, 25, -483, -865, -1023, -915, -569, -75, 438, 837, 1019, 936, 610, 125, -392, -807, -1013, -955, -650, -175, 345, 775, 1004, 972, 688, 224, -297, -742, -993, -987, -724, -273, 249, 706, 980, 999, 759, 321, -200, -669, -964, -1009, -792, -369, 150, 630, 946, 1016, 822, 415, -100, -590, -926, -1021, -851, -460, 50, 548, 903, 1024, 878, 505, 0},
	{865, 438, -125, -650, -972, -993, -706, -200, 369, 822, 1021, 903, 505, -50, -590, -946, -1009, -759, -273, 297, 775, 1013, 936, 569, 25, -526, -915, -1019, -807, -345, 224, 724, 999, 964, 630, 100, -460, -878, -1024, -851, -415, 150, 669, 980, 987, 688, 175, -392, -837, -1023, -891, -483, 75, 610, 955, 1004, 742, 249, -321, -792, -1016, -926, -548, 0},
	{837, 345, -273, -792, -1021, -878, -415, 200, 742, 1013, 915, 483, -125, -688, -999, -946, -548, 50, 630, 980, 972, 610, 25, -569, -955, -993, -669, -100, 505, 926, 1009, 724, 175, -438, -891, -1019, -775, -249, 369, 851, 1024, 822, 321, -297, -807, -1023, -865, -392, 224, 759, 1016, 903, 460, -150, -706, -1004, -936, -526, 75, 650, 987, 964, 590, 0},
	{807, 249, -415, -903, -1009, -688, -75, 569, 972, 964, 548, -100, -706, -1013, -891, -392, 273, 822, 1024, 792, 224, -438, -915, -1004, -669, -50, 590, 980, 955, 526, -125, -724, -1016, -878, -369, 297, 837, 1023, 775, 200, -460, -926, -999, -650, -25, 610, 987, 946, 505, -150, -742, -1019, -865, -345, 321, 851, 1021, 759, 175, -483, -936, -993, -630, 0},
	{775, 150, -548, -980, -936, -438, 273, 851, 1016, 688, 25, -650, -1009, -878, -321, 392, 915, 993, 590, -100, -742, -1023, -807, -200, 505, 964, 955, 483, -224, -822, -1021, -724, -75, 610, 999, 903, 369, -345, -891, -1004, -630, 50, 706, 1019, 837, 249, -460, -946, -972, -526, 175, 792, 1024, 759, 125, -569, -987, -926, -415, 297, 865, 1013, 669, 0},
	{742, 50, -669, -1019, -807, -150, 590, 1004, 865, 249, -505, -980, -915, -345, 415, 946, 955, 438, -321, -903, -987, -526, 224, 851, 1009, 610, -125, -792, -1021, -688, 25, 724, 1024, 759, 75, -650, -1016, -822, -175, 569, 999, 878, 273, -483, -972, -926, -369, 392, 936, 964, 460, -297, -891, -993, -548, 200, 837, 1013, 630, -100, -775, -1023, -706, 0},
	{706, -50, -775, -1019, -630, 150, 837, 1004, 548, -249, -891, -980, -460, 345, 936, 946, 369, -438, -972, -903, -273, 526, 999, 851, 175, -610, -1016, -792, -75, 688, 1024, 724, -25, -759, -1021, -650, 125, 822, 1009, 569, -224, -878, -987, -483, 321, 926, 955, 392, -415, -964, -915, -297, 505, 993, 865, 200, -590, -1013, -807, -100, 669, 1023, 742, 0},
	{669, -150, -865, -980, -415, 438, 987, 851, 125, -688, -1024, -650, 175, 878, 972, 392, -460, -993, -837, -100, 706, 1023, 630, -200, -891, -964, -369, 483, 999, 822, 75, -724, -1021, -610, 224, 903, 955, 345, -505, -1004, -807, -50, 742, 1019, 590, -249, -915, -946, -321, 526, 1009, 792, 25, -759, -1016, -569, 273, 926, 936, 297, -548, -1013, -775, 0},
	{630, -249, -936, -903, -175, 688, 1021, 569, -321, -964, -865, -100, 742, 1013, 505, -392, -987, -822, -25, 792, 999, 438, -460, -1004, -775, 50, 837, 980, 369, -526, -1016, -724, 125, 878, 955, 297, -590, -1023, -669, 200, 915, 926, 224, -650, -1024, -610, 273, 946, 891, 150, -706, -1019, -548, 345, 972, 851, 75, -759, -1009, -483, 415, 993, 807, 0},
	{590, -345, -987, -792, 75, 878, 936, 200, -706, -1013, -460, 483, 1016, 688, -224, -946, -865, -50, 807, 980, 321, -610, -1024, -569, 369, 993, 775, -100, -891, -926, -175, 724, 1009, 438, -505, -1019, -669, 249, 955, 851, 25, -822, -972, -297, 630, 1023, 548, -392, -999, -759, 125, 903, 915, 150, -742, -1004, -415, 526, 1021, 650, -273, -964, -837, 0},
	{548, -438, -1016, -650, 321, 993, 742, -200, -955, -822, 75, 903, 891, 50, -837, -946, -175, 759, 987, 297, -669, -1013, -415, 569, 1024, 526, -460, -1019, -630, 345, 999, 724, -224, -964, -807, 100, 915, 878, 25, -851, -936, -150, 775, 980, 273, -688, -1009, -392, 590, 1023, 505, -483, -1021, -610, 369, 1004, 706, -249, -972, -792, 125, 926, 865, 0}};

static const short mel_table[] = {0, 1, 1, 2, 2, 3, 3, 4, 4, 5, 5, 6, 6, 7, 7, 8, 9, 9, 10, 10, 11, 12, 13, 13, 14, 15, 16, 16, 17, 18, 19, 20, 21, 22, 23, 24, 25, 26, 27, 28, 29, 30, 31, 32, 34, 35, 36, 38, 39, 40, 42, 43, 45, 46, 48, 49, 51, 53, 55, 56, 58, 60, 62, 64};

static const int sampleLib[SAMPLE_LIB_SIZE][CEPS_COUNT][SIGNIFICANTS] = {

		//ylös
		{
		{2718208, 2690540, 643044, -1759191, -2978562, -2248024, -2485020, -3265382, -1991042, 34504, },
		{4043254, 2132835, -307919, -2198339, -3219668, -3168531, -2877533, -1926513, 51052, 1501643, },
		{4989546, 2051305, -638595, -2371379, -3364064, -2640165, -1703454, -569209, 640109, 1129685, },
		{2627937, -393088, -3433503, -3996244, -3255589, 546381, 2265105, 2006172, 1167362, 854074, },
		{809541, -1597058, -3923214, -3603581, -1483826, 2187266, 2922644, 1583790, -210042, -1051231, },
		{1499481, -1770050, -4318505, -3524756, -1099965, 3109634, 3883267, 1315783, -952534, -2319702, },
		{2555811, -654508, -3621622, -3350253, -962333, 3110392, 3607998, 782885, -752578, -2187523, },
		{1955798, -829571, -4185637, -2972238, -566070, 3013717, 2927589, 714423, -1368769, -2578152, },
		{1824145, -944221, -4046399, -3750877, -1227331, 2909839, 3800869, 1075983, -792142, -2413099, },
		{2974806, -790995, -3185383, -2977447, -1063741, 2896871, 3790685, 1432109, -881159, -2088552, },
		{2805566, -11571, -3173188, -3375876, -2154834, 1233269, 2095049, 464686, -968899, -1798219, },
		{768747, 1451230, -1875339, 341485, -1640383, 927112, -905677, 331884, -805463, -128337, },
		{-1156433, 1390241, -2469903, 1255541, -1860232, 1647248, -750417, 1179597, -736227, 146484, },
		{-770097, 1098512, -1859905, 1174872, -1609568, 1488973, -1045012, 1283538, -1097842, 477889, },
		{-1175444, 1200973, -1717809, 1202535, -1636408, 1214458, -1165643, 1120284, -769834, 421946, },
		{-1484482, 1483253, -2284886, 1799913, -1804176, 1589516, -1298633, 1025524, -864617, 402976, },
		{-1874369, 1593544, -2198120, 1728457, -1955791, 2104499, -1451950, 786938, -323302, -157497, },
		{-1335156, 1871866, -2161046, 1817812, -2128564, 1575138, -1340916, 839186, -571491, 70413, },
		{-628246, 855742, -1137965, 558653, -843001, 736030, -360683, 105445, -218652, -218464, },
		{53831, -128742, -302715, -295574, -96195, 377591, 205208, 13934, -92463, -103782, },
		{-1082999, 130519, 464946, -271198, -697763, 706924, 118206, -442793, -93466, 207261, },
		{342375, 235909, 25848, -16183, -30887, 92456, -29256, -56423, -118407, -93223, },
		{817959, 367894, -176410, -274408, -119007, 209916, 382660, 461643, 275692, 94387, },
		{310163, 101546, -231280, -328132, -248623, -25567, 95016, 198572, 167067, 81263, },
		},


		//alas
		{
		{-1452590, -1659050, -1201855, 1403357, 277622, 27060, -18278, 308194, -819460, -525207, },
		{-585591, -2164957, -1386492, 1291640, 1563842, 522209, 466576, -424292, -1463055, -1158141, },
		{-1740663, -3431091, -2385674, 1833647, 1791141, -27476, -91091, -752177, -1160888, -1018691, },
		{-1186594, -3256036, -2370250, 1864831, 1572923, 134788, 203769, -722200, -1758800, -1513003, },
		{1419095, -1554989, -3408523, -1254563, -633272, 448848, 1803795, 2150957, 689752, -972502, },
		{1420611, -1015741, -3940703, -3933269, -2509125, 865769, 2674569, 3338519, 2106796, 941568, },
		{2652674, -627478, -3128112, -3475451, -3406254, -611855, 1177117, 2459654, 2100977, 965510, },
		{199236, -1721113, -2951264, 474002, 820197, 486971, 1060414, 1108488, -963300, -2869428, },
		{-1972477, -1791230, -460749, 2708744, 203758, -824587, -66121, -340754, -530144, -1252385, },
		{-2219073, -3004626, -420551, 3471416, 390746, -1158689, -134904, 365435, -1106743, -1888824, },
		{-1207846, -2990159, -1814788, 2193838, 668473, -595258, -145431, -965054, -3067464, -2061253, },
		{-880667, -2676272, -1715666, 1564996, 1176700, 167397, 571083, -984416, -2980098, -2672904, },
		{-573735, -2089438, -934183, 1803242, 849422, 301205, 859437, -124800, -2272704, -2457483, },
		{169244, -2316888, -2379518, 767283, 2055417, 1742623, 1355093, -291656, -2110792, -1386630, },
		{137344, -1681164, -3066250, -475968, 66409, 1884184, 285549, -13276, -1619935, -655147, },
		{-959513, 1052395, -1244401, 808212, -944929, 355976, -579065, 552862, -477635, 354953, },
		{-1091776, 806686, -1041866, 890341, -1196443, 1010373, -1072919, 762487, -762617, 584415, },
		{-737793, 643271, -1268069, 838603, -974726, 887624, -499785, 606361, -801991, 190036, },
		{-752110, 722462, -1069863, 1006275, -1204140, 1091996, -1082851, 827799, -764746, 614226, },
		{-450273, 390409, -765037, 683976, -620921, 470651, -418938, 243449, -291506, 147197, },
		{-662878, 728851, -738586, 913782, -805438, 581732, -637606, 579395, -577185, 495202, },
		{-1033321, 815733, -1314377, 1046437, -1281260, 1313544, -1126921, 1263155, -1065689, 969646, },
		{-236414, 211124, -262880, 262183, -241778, 363197, -139003, 200023, -287691, 15169, },
		},

		//vasen
		{
		{3479055, -298450, -3190785, -3765267, -2731489, -230727, 809026, 877884, 774940, 9359, },
		{252601, -2192538, -2937388, -542779, 1719189, 2483792, 1074186, -374159, -2670558, -2661938, },
		{-580296, -2809317, -2609681, 1817698, 2130848, 54726, -570745, -1520370, -2479795, -1064227, },
		{-1947797, -2482572, -1140325, 1920043, -244571, 108240, 270369, -127375, -2807640, -2491590, },
		{-1770427, -2386461, -1209425, 2239988, 386286, 243371, 820591, -194553, -2504842, -2413893, },
		{-99954, -1685192, -1557452, 1655254, 1501764, 931260, 1621850, 143446, -2473664, -2862592, },
		{1013733, -1995319, -3404691, -1336472, 254004, 1392304, 1962201, 613789, -1558745, -1630273, },
		{619876, 160101, -1860336, -565229, -1304821, 689435, -56866, 513898, -523065, -88412, },
		{-247077, 326129, -673923, 497906, -586287, 667452, -268429, 538582, -422773, 193538, },
		{695576, -46243, -1549603, -476174, -960091, 539626, -34632, 251781, -744683, 38475, },
		{1641842, -246057, -2114331, -2017789, -1995599, -80146, 797743, 910717, -119220, 673043, },
		{1315662, 79498, -2296654, -1631098, 333002, 2302577, 1187650, -143763, -924846, -1008271, },
		{779646, -2003755, -4807196, -2930872, 903584, 3789611, 2437136, 397315, -1334705, -2800324, },
		{-7332, -1529918, -3911474, -2894355, 234870, 2995583, 1693117, -1092848, -1667802, -1838491, },
		{220805, -2058701, -4641224, -2841840, 509909, 3375715, 2432110, -56103, -2407610, -2898911, },
		{-181307, -1276231, -3497881, -3127526, 632044, 4076006, 2351160, -299044, -1246854, -3081612, },
		{2026572, -1327233, -4148349, -3035534, 278327, 2903838, 1442983, -875132, -2189230, -2691631, },
		{2601384, 156166, -2107426, -2696863, -1933001, -600632, 73318, 65391, -152215, -571995, },
		{2890022, 1093850, -1238591, -1952978, -1922592, -1209239, -205217, -459108, -570262, -483988, },
		{2172374, 1357944, -239666, -1142217, -1673687, -1494567, -920029, -1007313, -307140, 81344, },
		{1807021, 851614, -620821, -1351783, -1480587, -961059, -541609, -732064, -129224, 328554, },
		{748874, 69334, -543580, -403209, -374845, -66181, -215886, -360402, -362685, -140827, },
		{-1782, -474805, -245953, -215775, -25433, 415437, 200107, -304056, -350599, -200623, },
		{-207697, -347371, -47264, -34163, -167353, 92789, 18433, -259203, -233964, 74992, },
		{-239269, -307812, -223909, -248943, -247028, 405584, 259474, -263770, -263520, 229897, },
		{-215141, -208339, -110926, -22314, 57225, 243083, -38501, -251589, -176594, 90325, },
		},


		//oikea
		{
		{1965265, -1302530, -3106589, -2665293, -1484335, 393736, 1209161, 1589305, 388429, -1340408, },
		{657464, -3060400, -4235970, -1999404, 840983, 1933051, 186161, 435009, -278638, -813380, },
		{773653, -1630367, -3532609, -1967020, -317981, 2354876, 3033712, 3647511, 807882, -2229438, },
		{894387, -1918829, -3421646, -2072827, -430085, 1618048, 3080062, 2601510, -670243, -2180665, },
		{1240626, -1927527, -3594565, -2253561, -810864, 362885, 2624249, 3568938, 210236, -439915, },
		{1491611, 81992, -3133008, -2925393, -2328665, -84520, 2400322, 3142345, -154040, -57502, },
		{1569546, -219988, -3589024, -3286161, -3107559, -348379, 1714322, 2691535, 2399218, 1550764, },
		{1308972, -849728, -3839018, -3566037, -2674755, -300849, 2140905, 2652595, 325917, -373303, },
		{2652931, 1556368, -2257176, -3565096, -3561464, -1666961, 455381, 2071592, 1221675, 1853322, },
		{3423862, 2085639, -1842674, -3092352, -3955432, -4082304, -2479687, -554566, 570326, 1617578, },
		{2486832, 1446754, -877222, -1651524, -2325581, -2157148, -1549292, -598613, -46953, 382141, },
		{572138, 28928, -496364, -565319, -385794, -143244, 164113, 337339, 160351, -34538, },
		{358094, -32636, -460736, -494152, -331147, -184057, 50929, 198078, 56020, 3172, },
		{414240, 31859, -431871, -501005, -447654, -163117, 145016, 298753, 244249, 140189, },
		{-1245383, 1165699, -1845793, 638602, -837182, 384591, -184869, 432731, 288725, 319586, },
		{1410908, 1324620, -1540918, -1917543, -2916093, -2287862, -640088, 465823, 1118463, 1373022, },
		{1897465, 12425, -3490027, -3885659, -3454811, -1145633, 1578536, 2993188, 500831, 342987, },
		{580393, -860829, -3575938, -2693291, -1161272, 1264924, 3188860, 3270722, 951791, -807443, },
		{1228218, -1040854, -4224791, -3223121, -40666, 2593300, 1974090, 950527, -1283324, -1816382, },
		{873325, -1489465, -4027136, -2593406, 1681258, 4533150, 1905426, -303207, -2247218, -2601494, },
		{-176092, -1735849, -2547388, -111445, 2470873, 2776153, 607362, -655475, -2051649, -1350525, },
		{-300880, -1769156, -2077899, 1097903, 1962240, 2413713, 1263290, -1875684, -2248681, 86030, },
		{-101133, -2709326, -2533222, 1493056, 2425766, 2955189, 1478850, -883333, -1632672, 90143, },
		{-479092, -1494139, -1512008, 1215093, 448310, 910174, 1125346, 163446, -2072883, -1347313, },
		{-85205, -1673797, -548673, 741939, 33498, -541482, -803275, -50704, 458957, 846848, },
		{-252544, -1531533, -536706, 363710, 63202, 219262, 252684, -62869, -742900, -426082, },
		{-112871, -950863, -710406, 10926, -3281, 93413, 274910, 275493, -171451, -266346, },
		{-43280, -275103, -388728, -165626, -39063, 258432, 406524, 73448, -360937, -370456, },
		{102211, -235918, -512596, -229116, 118786, 338091, 263040, 59092, -248609, -245390, },
		},

		//AMMU
		{
		{-717863, -2397922, -2323354, 1141183, 988247, 250486, -520249, -1573898, -1796195, 517266, },
		{-1699582, -2746215, -1737405, 2242646, 287398, 163852, 694572, -97746, -1570161, -1161612, },
		{-2641542, -2764906, -666980, 2160254, -28759, 450149, 1643315, -473120, -2727728, -2170757, },
		{-1386717, -1806293, -694463, 933650, -800826, 95476, 1094790, -249197, -2222998, -2327109, },
		{-627748, -2022526, -241931, 1951930, -411495, -838074, 166084, 1252111, 70693, -1512895, },
		{1847807, -822219, -2180877, -676307, 909340, 1571182, 1155411, 538843, -1088986, -1897186, },
		{3862819, 1155190, -575196, -1037667, -1800806, -2461687, -2694242, -2202082, -1551408, -559024, },
		{4301551, 1514190, -462529, -1017366, -2079186, -3349140, -4164451, -3185197, -1671932, -92587, },
		{5404725, 2770225, 570308, -550771, -1794801, -2589506, -2934131, -2576735, -1693093, -651568, },
		{3861030, 1647506, -59190, -547093, -1496596, -2136115, -2782305, -2512418, -1999537, -1376769, },
		{3893903, 1656902, -645026, -1189452, -1919314, -2578453, -2786845, -2622855, -1892559, -764588, },
		{4645468, 2262638, 333628, -62959, -894970, -1705918, -2551097, -2772841, -2222227, -1128856, },
		{3157738, 1629173, 261962, -219029, -1374820, -1624895, -2323675, -2392729, -2257497, -1332004, },
		{3693562, 1284865, -662301, -1350335, -1777578, -2150654, -2723627, -2689974, -1840058, -765897, },
		{4655901, 2404568, 411439, -229103, -942106, -1690543, -2559707, -3189420, -2565562, -1253570, },
		{3695138, 1675763, -153537, -219763, -913473, -1455789, -2666935, -3174018, -2867554, -1942389, },
		{5003479, 1330304, -1922079, -2943253, -3589204, -2627751, -848784, 463277, 426792, 25798, },
		{2944168, -429239, -3093659, -3419232, -2722145, -393760, 1466541, 1674010, 900659, 628228, },
		{3871104, -564041, -3325038, -3599633, -2350859, 273238, 1344600, 364927, -290868, -537153, },
		{4210710, -465047, -3318337, -3743104, -2596814, -528206, 219659, 203776, 296486, 296610, },
		{2086967, -602505, -2395661, -2248095, -715675, 767798, 526319, -325076, -424395, -138371, },
		{1467016, -451199, -1485829, -1028372, -294247, 352400, 314792, -20250, -426247, -594880, },
		{325729, -533921, -728726, -50523, 356768, 414845, -21315, -287499, -332016, -77848, },
		{169182, -269457, -389668, -41353, 188474, 134591, -37771, -137829, -119310, 88659, },
		{343992, 35089, -212788, -58897, 106344, 184874, 150964, 81106, 7018, 47661, },
		{881479, 717718, 525304, 557966, 559320, 541893, 398519, 328589, 229882, 200120, },
		{1541479, 1198847, 750577, 560855, 333431, 208538, 45917, -16456, -79240, -116708, },
		{1291377, 903570, 473898, 250087, -44948, -210284, -355895, -432635, -518551, -423560, },
		{2565900, 2119551, 1488625, 985607, 457796, 117163, -294314, -512622, -748177, -805133, },
		{1087625, 822737, 438358, 202246, -27736, -171871, -281663, -326938, -334103, -298993, },
		{546572, 521476, 341292, 352828, 283277, 213684, 139003, 91233, 7965, 10739, },
		},

		//PERU
		{
		{2413411, -1014867, -4011142, -4447224, -2865353, 1300612, 3288383, 2160533, 444893, -270124, },
		{-255550, -1124690, -3584100, -3865229, -2321812, 1778832, 3082475, 1547202, 260443, -571856, },
		{-589823, -1815900, -3061713, -2850975, -1270798, 1777732, 2375018, 1364456, 132526, -1329792, },
		{-590452, -1864995, -4314817, -3299565, -245960, 3147377, 2886015, 1261383, -736141, -1986737, },
		{262887, -1825670, -4520805, -3639981, 1012473, 4531378, 2922492, 543212, -1481455, -3186864, },
		{-196720, -2202886, -4174599, -2978212, 1023310, 5261256, 2992093, -621398, -2182027, -2417412, },
		{1204281, -162614, -2792183, -2027132, 179109, 2743295, 2446807, -686932, -2105558, -2455750, },
		{665311, -847202, -2817478, -2506053, -850085, 2333405, 2712447, -672118, -2043270, -1704723, },
		{-1061709, -91606, -565137, -2212642, -1262225, 1584249, 1158649, -1134586, -1309499, -525007, },
		{-147190, -170188, 367011, -871627, -1146839, 491291, 613794, 55674, -474417, 113628, },
		{1879015, -624002, -2370374, -2738120, -2004667, 241830, 1926729, 1717387, 509482, -266136, },
		{3244006, -436388, -3026983, -3466654, -2334088, 38560, 1315652, 2324270, 1522955, -755, },
		{3113997, -152203, -2552633, -2809364, -2125021, -474739, 433375, 1275793, 1533484, 392286, },
		{3706455, -247716, -2956043, -3748723, -3206460, -1294028, 648840, 1715032, 1846612, 1247194, },
		{3626720, -313389, -3314856, -4150405, -3634466, -1253572, 627978, 1640041, 1815409, 1659446, },
		{3725564, 77083, -3001411, -3512478, -2910003, -998300, 358316, 827681, 662489, 767426, },
		{3523110, -909218, -3583138, -4201158, -3425750, -1304350, 322929, 999772, 1301630, 1620590, },
		{3011395, -870849, -3262608, -3727889, -2824013, -992431, 146369, 442409, 1072042, 1753195, },
		{1782063, -1016858, -2400706, -1766953, -750178, 119835, 163687, 46941, 15241, -84437, },
		{589903, -461642, -960565, -526982, -118322, 188151, 32274, -275, -41133, 87106, },
		{181228, -514268, -726469, -301152, 22854, 163711, 136218, 10961, -110564, -116018, },
		{276254, -238393, -548994, -417923, -178016, 94526, 100491, 13999, -36676, 6077, },
		},
		/*
		{
		{2448955, -1290106, -4607022, -5309250, -3314876, 364929, 1703055, 1400329, 1235836, 422486, },
		{4882462, 2845505, 47228, -1026240, -1588019, -1114819, -928073, -1489608, -2495119, -3328859, },
		{746119, -1115206, -3885091, -2594787, 1015395, 3940422, 3471174, 392541, -2369327, -3732997, },
		{-173950, -3523657, -4884643, -2212222, 1260732, 4708664, 3667322, 951559, -1580204, -3558105, },
		{-24658, -2591532, -5190407, -3294052, 829402, 4502017, 3184052, 668194, -966412, -3223319, },
		{1173290, -1668100, -3850061, -2457140, 1223688, 4063877, 2725510, 356819, -995185, -2739728, },
		{778600, -908532, -3809987, -1887497, 1226676, 3582119, 1981946, 433270, -976104, -2684119, },
		{1284922, -1053465, -2682330, -1958647, 573627, 2929540, 2183212, 139402, -1731677, -2349801, },
		{960524, -294037, -1689492, -1806633, -1138528, 392724, 1396300, -544107, -1080944, -224716, },
		{828171, -199304, -771480, -823835, -1822841, -521090, 977566, -211614, -1913093, -534635, },
		{1411716, -1366028, -3882311, -3281785, -1502306, 1686257, 3099846, 1869940, -470928, -1636583, },
		{1628667, -1340282, -3134583, -2241648, -1040682, 745580, 2295421, 3253021, 1126669, -1353897, },
		{1975562, -2006699, -3722237, -2444920, -578440, 1189573, 1330443, 2089886, 910226, -1406177, },
		{2115730, -1845239, -3909785, -2525736, -611178, 2182293, 2520474, 1495370, 358641, -1281387, },
		{1542175, -2273094, -3767521, -2555248, -836940, 1210364, 1473730, 1956391, 1432070, -279714, },
		{2524635, -1537040, -3484436, -2774616, -1024249, 543905, -110729, -335385, 829693, 1178690, },
		{3128923, -775702, -2707581, -1984729, -486833, 928177, 311683, -727684, -920728, -615688, },
		{3007253, -748330, -2347417, -1708710, -354709, 519160, -6307, -489544, -251733, 372452, },
		{1670576, -1105125, -2315708, -1398023, -3603, 789653, 228315, -144189, -14796, 351880, },
		{560606, -277912, -607774, -38971, 458378, 589471, 195017, -297431, -548545, -369661, },
		{744749, 99966, -142363, 155105, 316144, 329231, 96549, -108918, -192122, -152515, },
		{2771624, 1836992, 961207, 514143, 92234, -55535, -274474, -400782, -482675, -383944, },
		{870930, 721425, 540217, 465579, 353442, 362704, 193900, 158515, 73407, 35731, },
		{949377, 740633, 423960, 394832, 284260, 268964, 214099, 122987, -4837, -42071, },
		{2190985, 1945200, 1543290, 1369503, 1076465, 819246, 541972, 271272, 57071, -108249, },
		{670702, 563444, 348285, 361760, 325691, 297170, 229483, 121833, -29580, -40610, },
		{2195515, 2019217, 1672369, 1400661, 1094034, 836085, 613685, 383077, 168913, 52520, },
		{571834, 618471, 425690, 446512, 312453, 230882, 148933, 196167, 113505, 151604, },
		},
		*/
		//KOHINAA
		{
		{227582, -579574, 93029, 313458, 562456, 683742, 165250, -166934, -800238, -1050090, },
		{-270208, -1541563, -351985, 554767, 516711, 75227, -493330, -367292, -384993, -627084, },
		{-890066, -1284514, 550845, 492106, 73688, 471474, -85745, 362992, 731150, -182819, },
		{145040, -1646274, -852346, 142935, 203410, 203015, -35099, 36121, -317475, -827040, },
		{-1678576, -2481106, 313501, 1573595, -830648, -1365499, -982159, -413943, -361323, -837427, },
		{-1319124, -2925382, -542150, 1517938, 572305, -971462, -1985106, -320207, 602943, -225592, },
		{-2175794, -3742805, -1104222, 1322794, -650204, -1206261, -745552, 1091747, 1190978, -370251, },
		{-3000206, -3380284, -974515, 1608624, -201813, -1291161, -1370782, 1294129, 971501, -380635, },
		{-975800, -3131357, -319123, 2042922, -265365, -1146247, -1440179, 34935, 290945, -1170705, },
		{-429990, -1693303, -133752, 674865, 56064, -50544, -90819, -424263, -669698, -334097, },
		{537414, -633775, 162332, 265971, -38545, -377272, -966412, -485411, 191585, -132585, },
		{-350700, -997202, 95677, 375655, -359372, -531857, -269233, 154455, -118258, -342675, },
		{-981879, -1487346, 379941, 572361, -11490, -165710, -367647, -120606, -250940, -613358, },
		{-72946, -1441713, -699349, -925987, -61800, 996572, -492567, -724649, 121122, -107559, },
		{-762475, -1131223, 347346, -325849, 4239, 382555, -1184980, -570716, 590409, -687367, },
		{-1314187, -2078633, -1376338, -1936678, -3146798, -1182054, 746791, 2138418, 608813, 196846, },
		{-1093927, -1121220, 670481, 243929, -257056, 77981, -409751, -110420, 204166, -352057, },
		{493801, -1325944, -181813, 311952, -331898, -468995, -13079, 261169, -928921, -1577632, },
		{20652, -114553, 466872, 597284, 100465, -230103, -205241, 30459, -157335, -396677, },
		{138241, -1892846, -1011187, 1063183, 636072, -2022124, -3052993, -1020155, 750251, 787920, },
		{1277083, 211882, -18713, 307251, -634694, -1456137, -1314951, -563246, -387866, -456938, },
		{101756, -8094, -15116, 88436, -76490, -164498, -113946, -19517, -92594, -117170, },
		},


};

static const int sampleLengths[SAMPLE_LIB_SIZE] = {24, 23, 26, 29, 31, 22, 22}; //TODO: update this along with sampleLib

void Sound_init(UI * ui, bool recording)
{

	// init devices
	NutLoadConfig();

	if (ConfigInit()) {
		/* No configuration memory, run with factory defaults. */
		ConfigResetFactory();
	}
	else {
		if (ConfigLoad()) {
			/* No configuration info, use factory defaults. */
			ConfigResetFactory();
			ConfigSave();
		}
	}

	ResetDevice();

	int i;

	SoundStruct *ss = malloc( sizeof(SoundStruct) );
	ss->buffer = malloc( WIN_SIZE * CEPS_COUNT * sizeof(short) );
	ss->ui = ui;
	ss->recording = recording;
	ss->ceps_count = 0;

	ss->dtwTable = malloc( (CEPS_COUNT+1)*sizeof(short*) );
	for( i = 0; i< CEPS_COUNT+1; i++)
		ss->dtwTable[i] = malloc((CEPS_COUNT+1) * sizeof(short));

	printf("Create Thread\n");
	fflush(stdout);

	NutThreadCreate("SoundRecord", SoundRecord, (void *)(ss), 2048);
	NutThreadCreate("SoundFFT", SoundFFT, (void *)(ss), 1024);
}

THREAD(SoundFFT, arg)
{
	printf("SoundFFT started\n");
	fflush(stdout);
	SoundStruct* ss = arg;

	int i, j;

	//short x = 10;

	short * melBuffer = malloc( WIN_SIZE/2 * sizeof(short)); // 64
	short * cepsBuffer = malloc( CEPS_COUNT * WIN_SIZE * sizeof(short) ); // 4096
	short * real;

	short * im = malloc( WIN_SIZE * sizeof(short) ); // 128
	for(i = 0; i < WIN_SIZE; i++) im[i] = 0;


	int ** ceps = malloc(CEPS_COUNT * sizeof(int*)); // 32
	for( i = 0; i< CEPS_COUNT; i++)
		ceps[i] = malloc(SIGNIFICANTS * sizeof(int)); // 20

	if(ss->recording)
	{
		// wait for sample
		NutEventWait( &recordBufferReadyRead, 0 );

		memcpy( cepsBuffer, ss->buffer, ss->ceps_count * WIN_SIZE * sizeof(short) );
		real = cepsBuffer;

		SR_PreFilter(real, ss->ceps_count * WIN_SIZE);

		int ** sampleceps = malloc(CEPS_COUNT * sizeof(int*));
		for( i = 0; i< ss->ceps_count; i++)
			sampleceps[i] = malloc(SIGNIFICANTS * sizeof(int));

		for(i = 0; i < ss->ceps_count; i++)
		{
			SR_generateMFC(real, im, melBuffer, WIN_SIZE_E, sampleceps[i]);

			real += WIN_SIZE;


		}
		printf("Sample tallessa!\n\n%d\n", ss->ceps_count);

		// Tulostaa tallennetun samplen ja stoppaa


		printf("{\n");
		for( i = 0; i< ss->ceps_count; i++)
		{
			printf("{");
			for( j = 0; j < SIGNIFICANTS; j++)
			{
				printf("%d, ", sampleceps[i][j]);
			}
			printf("},\n");
		}
		printf("},\n");
		for(;;) NutThreadYield();
	}

	int minDist, minDistKey, distance, ceps_count;

	for(;;)
	{
		minDist = INT_MAX;
		minDistKey = 10;

		NutEventWait( &recordBufferReadyRead, 0 );

		//copy samples from ss->buffer to cepsBuffer
		memcpy( cepsBuffer, ss->buffer, ss->ceps_count * WIN_SIZE * sizeof(short) );
		real = cepsBuffer;
		ceps_count = ss->ceps_count;

		//SR_PreFilter(real, ss->ceps_count * WIN_SIZE);

		for(i = 0; i < ceps_count; i++)
		{
			SR_generateMFC(real, im, melBuffer, WIN_SIZE_E, ceps[i]);
			real += WIN_SIZE;
		}

		//recognition
		for(i = 0; i < SAMPLE_LIB_SIZE; i++)
		{
			distance = SR_DTWDistance(ss, ceps, i, ceps_count);

			if( distance < minDist )
			{
				minDist = distance;
				minDistKey = i;
			}
		}
		//printf("%d - %d\n", minDistKey, minDist);
		if ( minDist < DTW_TRESHOLD )
		{
			short com = 0;
			switch ( minDistKey ) {
			case 0:
				com = ARROW_UP;
				break;
			case 1:
				com = ARROW_DOWN;
				break;
			case 2:
				com = ARROW_LEFT;
				break;
			case 3:
				com = ARROW_RIGHT;
				break;
			case 4:
				com = ENTER_BUTTON;
				break;
			case 5:
				com = UNDO_BUTTON;
				break;
			default:
				break;
			}

			if(com != 0) UI_CQpush(ss->ui, com);


		}

		//printf("MinDistance: %d - %d\n", minDistKey, minDist);
		//fflush(stdout);

	}
	for(;;) NutThreadYield();
}


THREAD(SoundRecord, arg)
{

	printf("SoundAnalyzer started\n");
	fflush(stdout);
	VsTest();
	NutSleep(200);

	SoundStruct* ss = arg;

	int i;
	int recording = -1;

	ResetDevice();

	unsigned int samplecount = 0;
	short sample;

	short * recordBuffer = malloc( RECORD_BUFFER_SIZE * sizeof(short) );
	for(i = 0; i < RECORD_BUFFER_SIZE; i++)
		recordBuffer[i] = 0;

	i = 0;

	int absolute = 0;		 	//sum of the absolute values of samples
	short absoluteCount = 0; 	//number of recorded samples up to ABSOLUTE_COUNT
	bool readyToBegin = false;

	bool lastWindow = false;

	RecordDeviceInit(8000, 1, 0, 20);

	for(;;)
	{
		NutSleep(3);

		samplecount = VsRegRead(VS_HDAT1_REG);

		// spec page 54: if sci_hdat1 >= 896 may be better not
		// to read and wait for overflow
		while ( (samplecount > 0 && samplecount < 896 )) {

			samplecount--;
			sample = VsRegRead(VS_HDAT0_REG);

			recordBuffer[i] = sample;

			absolute += abs(sample);
			if( absoluteCount < ABSOLUTE_COUNT)
				absoluteCount++;

			else //the oldest sample must be deducted from the sum variable (absolute)
			{
				if ( i - ABSOLUTE_COUNT < 0)
					absolute -= abs(recordBuffer[RECORD_BUFFER_SIZE+i-ABSOLUTE_COUNT]);
				else
					absolute -= abs(recordBuffer[i-ABSOLUTE_COUNT]);
			}

			i++;
			if ( i == RECORD_BUFFER_SIZE )
			{
				i=0;
				readyToBegin = true;
				//printf("%d, ", absolute/ABSOLUTE_COUNT); //DEBUG
			}

			if( absoluteCount < ABSOLUTE_COUNT)
				continue; //recording does not begin until the averaging window has been fully covered

			//start recording, if the treshold is exceeded
			//if (readyToBegin && (absolute/ABSOLUTE_COUNT > RECORD_START) && recording == -1)
			if(readyToBegin && sample > RECORD_START && recording == -1)
			{
				setLedOn(_BV(_LED_1));

				recording = 0;

				/*
				if ( i < BACKTRACE )
				{
					memcpy(ss->buffer, recordBuffer+i-BACKTRACE, BACKTRACE-i);
					memcpy(ss->buffer+(BACKTRACE-i), recordBuffer, i);
				}
				else
					memcpy(ss->buffer, recordBuffer+i, BACKTRACE);
				*/

			}

			//if we are recording, save sample
			if ( recording != -1)
			{
				ss->buffer[BACKTRACE+recording] = sample;
				recording++;
			}

			if (recording >= 0 && ( (BACKTRACE+recording == WIN_SIZE* CEPS_COUNT) || (absolute/ABSOLUTE_COUNT < RECORD_STOP) ) )
				lastWindow = true; //-2 means that recording should be stopped whenever the last window is filled
			if( lastWindow && ((BACKTRACE + recording) % WIN_SIZE == 0) ) //dynamic length
			{
			//if ( ABSOLUTE_COUNT+recording == WIN_SIZE* CEPS_COUNT && recording != -1) {  //fixed length
				ss->ceps_count = (BACKTRACE + recording) / WIN_SIZE;
				lastWindow = false;
				if(ss->ceps_count < 5) continue;

				setLedOff(_BV(_LED_1));
				recording = -1;

				if(ss->ceps_count < MIN_CEPS_COUNT) continue;
				if(ss->ceps_count != CEPS_COUNT && ss->ceps_count > 3) ss->ceps_count -= 3;



				//WAWISETTI
//				printf("\n\n");
//				int j;
//				for(j = 0; j < 44; j++)
//					printf("%02x ", wavheader[j]);
//
//				printf("\n\n\n");
//				for(j = 0; j < ss->ceps_count*WIN_SIZE; j++)
//					printf("%02x ", recordBuffer[j]);
//
//				printf("\n\n\n");
//				for(;;)
//					NutThreadYield();

				NutEventPost( &recordBufferReadyRead );

				//for(;;)
				//	NutThreadYield();

				//break; //mihi tätä breakkii tarvitaan??
			}

		}
	}
}

void SR_generateMFC( short * real, short * im, short * mel_buffer, short samples_exp, int * cepstrum )
{
	SR_FFT(real, im, samples_exp);
	samples_exp--;
	SR_abs(real, im, samples_exp);


	//DEBUGGING... the tone of the recorderd voice:
//	int i, numerator, denominator, max, maxI;
//	numerator = 0;
//	denominator = 0;
//	max = 0; maxI = 0;
//	for(i = 0; i < 1<<samples_exp; i++)
//	{
//		if(real[i] > max) {max = real[i]; maxI = i;}
//		 numerator += i * real[i];
//		 denominator += real[i];
//	}
//	printf("%d, %d  --  ", numerator / denominator, maxI);

	SR_melscale(real, mel_buffer, samples_exp);
	SR_DCT(mel_buffer, cepstrum, samples_exp);
	//SR_DCT(real, cepstrum, samples_exp);

//	for(i = 0; i < SIGNIFICANTS; i++)
//	{
//		printf("%d, ", cepstrum[i]);
//	}
//	printf("\n");
}

void SR_PreFilter( short * real, short samples )
{

	// z = z - 0,95z^-1
	/*
	int i, j;
	for( i = (1 << samples); i >= 1; i--)
	{
		j = 95*real[i-1];
		j = j/100;
		real[i] = real[i]-j;
	}
	*/
}

void SR_abs( short * real, short * im, short samples_exp )
{
	int i;
	for( i = 0; i < (1 << samples_exp); i++)
	{
		real[i] = absolute(real[i], im[i]);
		im[i] = 0; //note! the im part is reinitialized here!
	}
}

void SR_FFT( short * real, short * imag, short samples_exp )
{
		fix_fft(real, imag, samples_exp, 0);
}

void SR_melscale(short* input, short * output, short samples_exp)
{
	int i, j, peakIndex, value;
	int numSamples = (1<<samples_exp);
	for(i = 0; i < numSamples; i++)
	{
		peakIndex = mel_table[i];
		value = 0;
		for(j = -1; j < 2; j++) //triangular overlapping window
		{
			if(peakIndex == 0 && j == -1) continue;
			if(j == 0) value += input[peakIndex + j] * 3;
			else value += input[peakIndex + j];
		}
		output[i] = value;
	}
}



void SR_DCT( short* fftbuffer, int * dctBuffer, short samples_exp)
{
	int k, n, x;

	for( k = 0; k < SIGNIFICANTS; k++)
	{
		x = 0;
		for( n = 0; n < (1<<samples_exp); n++ )
		{
			x += dcttable[k][n]*fftbuffer[n];
		}
		dctBuffer[k] = x;
	}
}

int SR_CepstrumDistance( int * recorded, int index, int index2)
{
	int i;
	int result = 0;
	for(i = 0; i < SIGNIFICANTS; i++){
		//printf("abs( %d - %d ) = %d", recorded[i], librarySample[i], abs(recorded[i] - librarySample[i]));
		result += (abs(recorded[i] - sampleLib[index][index2][i]));
	}
	return result;
}

//n: the length of the recorded word in cepstrums
//m: the length of the library word in cepstrums
int SR_DTWDistance(SoundStruct * ss, int ** recorded, int index, int n)
{
	int m, i, j, cost;
	m = sampleLengths[index];

	int ** table = ss->dtwTable;

	for(i = 0; i < m; i++)
		table[0][i] = table[i][0] = INT_MAX;

	table[0][0] = 0;

	for( i = 1; i <= n; i++)
	{
		for( j = 1; j <= m; j++)
		{
			cost = SR_CepstrumDistance(recorded[i-1], index, j-1);
			table[i][j] = cost + min(table[i - 1][j], min(table[i][j - 1], table[i - 1][j - 1]));
		}
	}
	return table[n][m];
}
